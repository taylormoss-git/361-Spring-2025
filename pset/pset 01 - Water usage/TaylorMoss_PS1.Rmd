---
title: "Pset 1 - Water usage"
author: "425/625"
date: "Spring 2024"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(pubtheme)
library(reshape2)
library(ggmosaic)
library(forcats)
```

## Introduction 

Water scarcity is a major issue in many parts of the world. According to the [United Nations](https://www.un.org/en/climatechange/science/climate-issues/water), "About two billion people worldwide don't have access to safe drinking water today ([SDG Report 2022](https://unstats.un.org/sdgs/report/2022/Goal-06/?_gl=1*aquqlc*_ga*MTAzMzA2ODI0Mi4xNzA0NjYzNjY3*_ga_TK9BQL5X7Z*MTcwNDY2NzIyMS4yLjEuMTcwNDY2NzI1My4wLjAuMA..)), and roughly half of the world’s population is experiencing severe water scarcity for at least part of the year ([IPCC](https://www.ipcc.ch/report/ar6/wg2/downloads/outreach/IPCC_AR6_WGII_FactSheet_FoodAndWater.pdf)). These numbers are expected to increase, exacerbated by climate change and population growth ([WMO](https://public.wmo.int/en/media/press-release/protect-our-people-and-future-generations-water-and-climate-leaders-call-urgent))."


In this problem set, we will investigate water usage estimates by crop in the United States. The `.csv` for this data set comes from [here](https://databank.illinois.edu/datasets/IDB-4607538) (by checking Select All and clicking Get Custom Zip) and the associated academic journal article is [here](https://agupubs.onlinelibrary.wiley.com/doi/10.1029/2022WR032804). See [this thread](https://twitter.com/MeganKonar/status/1618943789279875074?s=20&t=nrjRJQ2tuEO0GyTwCK-XVA) on X for a summary.  

Read the academic article to familiarize yourself with the basics of the water usage data. You don't need to know how these water usage levels were estimated, so you can skip over those parts. We are going to focus on visualizing the water levels using the estimates that they generated. 

## Data preparation

The `.zip` file `rawdata/DOI-10-13012-b2idb-4607538_v1.zip` contains one `.csv` file per source (SWW, GWW, GWD) per year from 2008 to 2020. There are also a couple of `.txt` files in the folder. We can use `unzip` with `list = TRUE` to see what's in the `.zip` file. 

```{r}
unzip(zipfile = 'rawdata/DOI-10-13012-b2idb-4607538_v1.zip', 
      list = TRUE) ## this lists the filename, but does not unzip the file
```

Before summarizing/visualizing this data, we'll want to join these data sets. We could certainly unzip the file manually. We can also do this in R using `unzip`. 

```{r eval=F}
unzip(zipfile = 'rawdata/DOI-10-13012-b2idb-4607538_v1.zip', 
      junkpaths = TRUE, 
      exdir = 'rawdata') ## gets rid of paths, keeps only filenames 
```


#### 1. Join data
First, let's create a data set with all years/crops together in one data frame. Below is some code to help you get started. Add comments to each place there is `##` to explain what the chunk of code is doing. Then add code to the `Tranforming data` Section to transform the data into a data frame with 5 columns: `GEOID`, `crop`, `source`, `year`, and `value` (indicating km^3 of water).

Note that `eval = F` at the start of the chunk will prevent this chunk from evaluating when you knit the document. You can temporarily remove it if you'd like, but you'll want to add it back before knitting the document so that knitting takes less time.

```{r eval = F}
sources = c('gwd', 'sw', 'gwa')
years = 2008:2020
d = NULL

for(s in sources){
  cat(s, '') ## show progress
  
  for(year in years){
    cat(year, '') ## show progress
  
    ## The code is reading in the data from the .csv file by combining directory, 
    ## the source, year, and .csv. The csv is then stored as a dataframe called df.
    filename = paste0('rawdata/', s, '_', year, '.csv')
    df = read.csv(filename)
    head(df)
    
    
    ## Tranform data #######################################
    ## Use `pivot_longer`, `separate`, and/or other functions to transform this
    ## data frame into a data frame with 5 columns: 
    ## GEOID, crop, source, year, and value (indicating km^3 of water)
    
    df = df %>%
      pivot_longer(cols = -GEOID, names_to = "crop_info", values_to = "value") %>%
      separate(col = 'crop_info', into = c("src", "crop", 'year'), sep = "\\.")
    
    
    ## end of transforming data ############################
    
    ## We then row bind the dataframe df to the master dataframe d.
    d = rbind(d, df)
  }
  
  cat('\n') ## start a new line before showing progress for the next source
}
head(d)
tail(d)
```


## Data exploration and summaries

Let's load the data we'll use for the rest of the assignment. This is the data set created in #1, so if you were unable to finish #1, you can still do the rest of the assignment. 

```{r}
d = readRDS('data/water.usage.rds')
head(d)
```


#### 2. Summaries of data 

Find the mean, the change from 2008 to 2020, and the percent change from 2008 to 2020, for each crop and each source (SWW, GWW, GWD). 

```{r}
dd = d %>%
  group_by(crop, src, year) %>%
  summarise(value = sum(value)) %>%
  group_by(crop, src) %>%
  mutate(mean = mean(value)) %>%
  filter(year %in% c(2008, 2020)) %>%
  pivot_wider(names_from = year, 
              values_from = value, 
              names_prefix = 'y') %>%
  mutate(diff=y2020-y2008,
         perc = diff/y2008*100) %>%
  ungroup()
head(dd)

write.csv(dd, 'water_usage_summary.csv')

```

## 3. Convert Table 2 to a visualization

Create a visual representation of the information in Table 2. Create a visualization (or visualizations) that contains mean, change, and percent change in water usage from each crop and source. 
Pivot longer
Title
labeled axes
text?
Visualization best practices
```{r}
ggplot(dd, aes(x = crop, y = mean, fill = src)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(title = "Mean Water Usage by Crop and Source (2008-2020)",
       x = "Crop",
       y = "Mean Water Usage (km^3)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
# Visualization for Change in Water Usage
ggplot(dd, aes(x = crop, y = diff, fill = src)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(title = "Change in Water Usage by Crop and Source (2008 to 2020)",
       x = "Crop",
       y = "Change in Water Usage (km^3)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}


# Visualization for Percent Change in Water Usage
ggplot(dd, aes(x = crop, y = perc, fill = src)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(title = "Percent Change in Water Usage by Crop and Source (2008 to 2020)",
       x = "Crop",
       y = "Percent Change in Water Usage (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


# Figure 4

Figure 4 shows the average water usage by crop and source.

- A. average irrigation water usage by source, colored by crop, 
- B. average irrigation water usage by crop, colored by source 

Two other options for visualizing a numeric variable broken down by two different categorical variable would be a tile plot/grid plot (e.g. https://github.com/bmacGTPM/pubtheme?tab=readme-ov-file#grid-plot) and a mosiac plot (https://haleyjeppson.github.io/ggmosaic/).


## 4. Create a tile plot/grid plot of the data in Figure 4. 

```{r}
df_melted <- melt(dd, id.vars = c("crop", "src"), measure.vars = "mean")
mean_center <- mean(c(min(df_melted$value), max(df_melted$value)))

ggplot(df_melted, aes(x = src, y = crop, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = mean_center) +
  labs(title = "Average Irrigation Water Use by Crop and Source (2008–2020)",
       x = "Source",
       y = "Crop",
       fill = "Average Use (km^3)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## 5. Create a mosiac plot of the data in Figure 4. 


```{r}
dd$mean_category <- cut(dd$mean, breaks = 4, labels = c("Low", "Moderate", "High", "Very High"))

ggplot(data = dd) +
  geom_mosaic(aes(weight = mean, x = product(crop), fill = mean_category)) +
  labs(title = "Mosaic Plot of Average Irrigation Water Use",
       x = "Crop",
       y = "Mean Water Usage Category",
       fill = "Usage Category") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_blank())
```


## 6. What are the benefits (other than it fits on one plot) and drawbacks of these two plots?
Mosaic plots excel in showing proportional relationships and comparisons between categorical data, but they can oversimplify continuous data like average water usage, leading to potential interpretative challenges, especially in crowded plots. Tile plots are more suited for visualizing continuous data, using color gradients to intuitively convey variations in values like water usage across categories. However, tile plots can sometimes lose finer details and depend heavily on color perception, which might be challenging for color vision-deficient viewers. In the context of irrigation water use by crop and source, a tile plot is more appropriate due to its effectiveness in displaying continuous variables.
## 7. Figure 6 

Figure 6 uses a different color scale for each plot. Discuss the benefits and drawbacks of this choice. What was the main purposes of this figure? Given the main purpose, would you recommend using the same color scale, or different color scales, for each plot?

Figure 6 uses different color scales in a misleading way particularly given how the scales vary across crop as well as across source. It fails to provide clear comparisons. I would use a different colored scale for each plot that has a different scale. This would allow for a more accurate comparison of the data.

## 8. Figure 8 

Figure 8 also uses a different color scale for each plot.  Discuss the benefits and drawbacks of this choice. What was the main purposes of this figure? Given the main purpose, would you recommend using the same color scale, or different color scales, for each plot?

The purpose of figure 8 is to illustrate the spatial differences between the irrigation water use estimates obtained from the PCR-GLOBWB 2 model and the values reported by the U.S. Geological Survey.  The use of different color scales enhances the detail and contrast within each dataset, allowing for a tailored interpretation that emphasizes specific ranges and nuances. However, this approach can hinder direct comparability across plots, as variations in scales may lead to misunderstandings or inaccurate assessments of relative differences. The inconsistency in visual representation can also add complexity to the interpretation process, potentially causing confusion for the reader. In the context of comparing model estimates to USGS data across different water sources and years, a consistent color scale might be more beneficial for easy comparison and coherent understanding. Given the context and purpose of the figure, if the intention is to allow readers to quickly gauge and compare the magnitude of discrepancies between model estimates and USGS data across different water sources and years, a consistent color scale across all plots would be more beneficial.


## 9. Breakdown of GWW
The paper notes in Section 3.1 that $GWW = GWW_{sustainable} + GWW_{unsustainable}$, and that $GWD = GWW_{unsustainable}$. Create a visualization showing the percent of GWW that is GWD for each crop. Use the mean values for water usage. 

```{r}
data_gww <- dd %>% filter(src == "gwa") %>% select(crop, mean) %>% rename(GWW = mean)
data_gwd <- dd %>% filter(src == "gwd") %>% select(crop, mean) %>% rename(GWD = mean)

merged_data <- merge(data_gww, data_gwd, by = "crop")

# Calculating the percent of GWW that is GWD for each crop
merged_data$Percent_GWD_of_GWW <- (merged_data$GWD / merged_data$GWW) * 100

ggplot(merged_data, aes(x = reorder(crop, Percent_GWD_of_GWW), y = Percent_GWD_of_GWW, fill = crop)) +
  geom_bar(stat = "identity") +
  coord_flip() +  
  ylim(0,100) +
  labs(title = "Percent of Groundwater Withdrawals that is Groundwater Depletion by Crop",
       x = "Crop",
       y = "Percent of GWW that is GWD (%)") +
  theme_minimal() +
  theme(legend.position = "none")
```


## 10. Custom visualization
What is another question you have about this data? Create a visualization that attempt to answer your question. 
What is the distribution of mean water usage across crops for each source? What are the ranges, median values? Are there outliers?
```{r}
ggplot(dd, aes(x = src, y = mean, fill = src)) +
  geom_boxplot() +
  labs(title = "Distribution of Mean Water Usage Across Crops by Water Source",
       x = "Water Source",
       y = "Mean Water Usage (km3)") +
  scale_fill_brewer(palette = "Set3", name = "Water Source") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") 

```

